<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Dan Belmonte</title>
<meta name="keywords" content="">
<meta name="description" content="Traefik currently seats on a custom version owned by us but the patch was merged into the upstream repository and needs to be back to the main docker image along with the upgrade to &gt; 2.5
Steps Check 2.4 and 2.5 releases for breaking changes Reference: https://doc.traefik.io/traefik/migration/v2/#v23-to-v24 Reference: https://doc.traefik.io/traefik/migration/v2/#v24-to-v25
ServersTransport -&gt; Update RBAC and CRD (To check in Helm chart for 2.4) This is done by the chart as it updates everything needed.">
<meta name="author" content="">
<link rel="canonical" href="https://dangaiden.github.io/post/2022/sys-1556-traefik-2.6-upgrade.md/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://dangaiden.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://dangaiden.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dangaiden.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://dangaiden.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://dangaiden.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="" />
<meta property="og:description" content="Traefik currently seats on a custom version owned by us but the patch was merged into the upstream repository and needs to be back to the main docker image along with the upgrade to &gt; 2.5
Steps Check 2.4 and 2.5 releases for breaking changes Reference: https://doc.traefik.io/traefik/migration/v2/#v23-to-v24 Reference: https://doc.traefik.io/traefik/migration/v2/#v24-to-v25
ServersTransport -&gt; Update RBAC and CRD (To check in Helm chart for 2.4) This is done by the chart as it updates everything needed." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dangaiden.github.io/post/2022/sys-1556-traefik-2.6-upgrade.md/" /><meta property="og:image" content="https://dangaiden.github.io/47"/><meta property="article:section" content="post" />



<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://dangaiden.github.io/47"/>

<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Traefik currently seats on a custom version owned by us but the patch was merged into the upstream repository and needs to be back to the main docker image along with the upgrade to &gt; 2.5
Steps Check 2.4 and 2.5 releases for breaking changes Reference: https://doc.traefik.io/traefik/migration/v2/#v23-to-v24 Reference: https://doc.traefik.io/traefik/migration/v2/#v24-to-v25
ServersTransport -&gt; Update RBAC and CRD (To check in Helm chart for 2.4) This is done by the chart as it updates everything needed."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://dangaiden.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "",
      "item": "https://dangaiden.github.io/post/2022/sys-1556-traefik-2.6-upgrade.md/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "",
  "name": "",
  "description": "Traefik currently seats on a custom version owned by us but the patch was merged into the upstream repository and needs to be back to the main docker image along with the upgrade to \u0026gt; 2.5\nSteps Check 2.4 and 2.5 releases for breaking changes Reference: https://doc.traefik.io/traefik/migration/v2/#v23-to-v24 Reference: https://doc.traefik.io/traefik/migration/v2/#v24-to-v25\nServersTransport -\u0026gt; Update RBAC and CRD (To check in Helm chart for 2.4) This is done by the chart as it updates everything needed.",
  "keywords": [
    
  ],
  "articleBody": "Traefik currently seats on a custom version owned by us but the patch was merged into the upstream repository and needs to be back to the main docker image along with the upgrade to \u003e 2.5\nSteps Check 2.4 and 2.5 releases for breaking changes Reference: https://doc.traefik.io/traefik/migration/v2/#v23-to-v24 Reference: https://doc.traefik.io/traefik/migration/v2/#v24-to-v25\nServersTransport -\u003e Update RBAC and CRD (To check in Helm chart for 2.4) This is done by the chart as it updates everything needed.\nK8S CrossNamespace\nK8S ExternalName Service\nDefined in the values.yaml which will be applied for the upgrade:\n![[Pasted image 20220127095012.png]]\nNon-ASCII Domain Names Update RBAC and CRD definitions. Headers middleware: ssl redirect options \u0026 accessControlAllowOrigin X.509 CommonName API version: The extensions/v1beta1 API Version should now be replaced either by networking.k8s.io/v1beta1 or by networking.k8s.io/v1 (as of Kubernetes v1.19+) Paysites (prod and staging)\nCurrent: helm.sh/chart=traefik-9.13.0 Containers: traefik2-frontend: Image: javipolo/traefik:2.3.3-router-metrics We need to put: traefik v2.5.6 ❯ helm search repo traefik -l | grep -i 2.5.6 traefik/traefik 10.9.1 2.5.6 A Traefik based Kubernetes ingress controller Check helm chart releases for breaking changes https://wiki.cac.washington.edu/display/MCI/Ingress+Resource+Changes+Kubernetes+1.19+through+1.21\nhttps://kubernetes.io/docs/reference/using-api/deprecation-guide/\nChanges in Ingress apiVersion make the object to be defined different:\nSpecific Changes to Ingress spec.backend is renamed to spec.defaultBackend\nThe backend serviceName field is renamed to service.name\nNumeric backend servicePort fields are renamed to service.port.number\nString backend servicePort fields are renamed to service.port.name\nI changed different YAML manifests where the backend service had a different structure. For each project I changed all the manifests.\n![[GH_changes_SYS-1556.png]]\nUpgrade tag in staging and deploy to paysites staging New parameters needed: ![[Pasted image 20220127095012.png]]\n\u0026\n![[Pasted image 20220127094937.png]]\nLatest 2.5.4 version in is:\n❯ helm search repo traefik -l | grep -i 2.5.6 traefik/traefik 10.9.1 2.5.6 A Traefik based Kubernetes ingress controller Destination chart: \u003e helm show values traefik/traefik --version 10.2.0 Helm uses the app version as tag so the process to upgrade is:\nhelm upgrade -i traefik2 --namespace staging -f values.yaml traefik/traefik This installs the latest version from Traefik!\nWhere values.yaml is the file where we override for our own values.\nhelm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.9.1 Check the traefik dashboard (http://127.0.0.1:9000) to see the general status of Traefik objects:\nkubectl port-forward deployment/traefik2 -n staging 9000:9000 Added new middleware within the same templates with - Example\n{{- $name := include \"chart.name\" . -}} apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: \"whitelist-{{ $name }}\" spec: ipWhiteList: ipStrategy: depth: {{ .Values.whitelist.depth }} sourceRange: {{- range .Values.whitelist.ips }} - {{ . }} {{- end }} --- apiVersion: traefik.containo.us/v1alpha1 kind: Middleware metadata: name: \"{{ .Release.Namespace }}-whitelist-{{ $name }}\" spec: ipWhiteList: ipStrategy: depth: {{ .Values.rssWhiteList.depth }} sourceRange: {{- range .Values.rssWhiteList.ips }} - {{ . }} {{- end }} Deploy your new ingresses that are pointing to your new apiVersion networking.k8s.io/v1 Once deployed, you probably can check that you haven’t missed anything by doing something like.\n❯ k get ingress -o yaml -A | grep apiVersion: | more apiVersion: v1 - apiVersion: networking.k8s.io/v1 - apiVersion: networking.k8s.io/v1 - apiVersion: networking.k8s.io/v1 - apiVersion: networking.k8s.io/v1 . . . Upgrade CRDs manually!!! How snippets work Great gist –\u003e Useful\nTraefik CRDs reference: https://github.com/traefik/traefik/blob/v2.5/docs/content/reference/dynamic-configuration/kubernetes-crd.md\nCRDs to be updated, in particular these definitions and the RBAC one\nCheck current CRDs from Traefik ❯ k get crd | grep traefik ingressroutes.traefik.containo.us 2020-10-16T13:49:48Z ingressroutetcps.traefik.containo.us 2020-10-16T13:49:48Z ingressrouteudps.traefik.containo.us 2020-10-16T13:49:48Z middlewares.traefik.containo.us 2020-10-16T13:49:48Z tlsoptions.traefik.containo.us 2020-10-16T13:49:48Z tlsstores.traefik.containo.us 2020-10-16T13:49:48Z traefikservices.traefik.containo.us 2020-10-16T13:49:48Z Exported Traefik CRDs k get crd -A | grep traefik | awk '{ print $1 }' | xargs -I % /bin/bash -c 'kubectl get crd % -o yaml \u003e %.yaml' After being sure that I am in the correct context and those are the CRDs I want to apply ❯ ./CRDs.sh Warning: resource customresourcedefinitions/ingressroutes.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically. customresourcedefinition.apiextensions.k8s.io/ingressroutes.traefik.containo.us configured Warning: resource customresourcedefinitions/ingressroutetcps.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically. customresourcedefinition.apiextensions.k8s.io/ingressroutetcps.traefik.containo.us configured Warning: resource customresourcedefinitions/ingressrouteudps.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically. customresourcedefinition.apiextensions.k8s.io/ingressrouteudps.traefik.containo.us configured Warning: resource customresourcedefinitions/middlewares.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically. customresourcedefinition.apiextensions.k8s.io/middlewares.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/middlewaretcps.traefik.containo.us created customresourcedefinition.apiextensions.k8s.io/serverstransports.traefik.containo.us created Warning: resource customresourcedefinitions/tlsoptions.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically. customresourcedefinition.apiextensions.k8s.io/tlsoptions.traefik.containo.us configured Warning: resource customresourcedefinitions/tlsstores.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically. customresourcedefinition.apiextensions.k8s.io/tlsstores.traefik.containo.us configured Warning: resource customresourcedefinitions/traefikservices.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically. customresourcedefinition.apiextensions.k8s.io/traefikservices.traefik.containo.us configured clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created After the CRDs are installed, I have a couple more: ❯ k get crd | grep traefik ingressroutes.traefik.containo.us 2020-10-16T13:49:48Z ingressroutetcps.traefik.containo.us 2020-10-16T13:49:48Z ingressrouteudps.traefik.containo.us 2020-10-16T13:49:48Z middlewares.traefik.containo.us 2020-10-16T13:49:48Z middlewaretcps.traefik.containo.us 2022-02-22T10:05:26Z serverstransports.traefik.containo.us 2022-02-22T10:05:28Z tlsoptions.traefik.containo.us 2020-10-16T13:49:48Z tlsstores.traefik.containo.us 2020-10-16T13:49:48Z traefikservices.traefik.containo.us 2020-10-16T13:49:48Z Now applying the upgrade with Helm to v.2.5.6 (chart version is 10.9.1) helm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.9.1 After applying the upgrade, all went well although some redirections didn’t work in the staging environment I applied it. Checked the logs and saw some middlewares were missing: {\"entryPointName\":\"websecure\",\"level\":\"error\",\"msg\":\"middleware \\\"staging-blue-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\\\" does not exist\",\"routerName\":\"tushyraw-frontend-blue-redesign-new-join-form-staging-blue-staging-blue-members-tushyraw-com-joinnow@kubernetes\",\"time\":\"2022-02-22T13:10:37Z\"} {\"entryPointName\":\"websecure\",\"level\":\"error\",\"msg\":\"middleware \\\"staging-blue-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\\\" does not exist\",\"routerName\":\"slayed-frontend-blue-redesign-new-join-form-staging-blue-staging-blue-members-slayed-com-joinnow@kubernetes\",\"time\":\"2022-02-22T13:10:37Z\"} {\"entryPointName\":\"websecure\",\"level\":\"error\",\"msg\":\"middleware \\\"staging-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\\\" does not exist\",\"routerName\":\"deeper-frontend-redesign-new-join-form-staging-staging-members-deeper-com-joinnow@kubernetes\",\"time\":\"2022-02-22T13:10:37Z\"} {\"entryPointName\":\"websecure\",\"level\":\"error\",\"msg\":\"middleware \\\"staging-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\\\" does not exist\",\"routerName\":\"vixen-frontend-redesign-new-join-form-staging-staging-members-vixen-com-joinnow@kubernetes\",\"time\":\"2022-02-22T13:10:37Z\"} After some investigation, I found that in the previous version of Traefik (2.3.3) the middlewares were already missing, so it wasn’t a problem with the upgrade.\nIn conclusion, the newer version of Traefik (2.5.6) simply gave an incorrect redirection for a Router when a middleware was missing but in the previous version don’t.\nIn the end, I created the missing middlewares and redirections were working as expected.\nUpgrading to 2.6.1 ❯ ./CRDs_2_6.sh customresourcedefinition.apiextensions.k8s.io/ingressroutes.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/ingressroutetcps.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/ingressrouteudps.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/middlewares.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/middlewaretcps.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/serverstransports.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/tlsoptions.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/tlsstores.traefik.containo.us configured customresourcedefinition.apiextensions.k8s.io/traefikservices.traefik.containo.us configured clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller unchanged clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller unchanged\n❯ helm search repo traefik -l | grep -i 2.6.1 traefik/traefik 10.14.2 2.6.1 A Traefik based Kubernetes ingress controller\nChange values.yaml tag for “2.6.1” Then:\nhelm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.14.2 --dry-run Real update:\n❯ helm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.14.2 Release \"traefik2\" has been upgraded. Happy Helming! NAME: traefik2 LAST DEPLOYED: Wed Feb 23 16:42:11 2022 NAMESPACE: staging STATUS: deployed REVISION: 29 TEST SUITE: None ",
  "wordCount" : "1168",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dangaiden.github.io/post/2022/sys-1556-traefik-2.6-upgrade.md/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dan Belmonte",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dangaiden.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://dangaiden.github.io" accesskey="h" title="Dan Belmonte (Alt + H)">Dan Belmonte</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://dangaiden.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://dangaiden.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://dangaiden.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://dangaiden.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://dangaiden.github.io/about-me/" title="About me">
                    <span>About me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      
    </h1>
    <div class="post-meta">6 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#steps" aria-label="Steps">Steps</a><ul>
                        <ul>
                        <ul>
                        <ul>
                        
                <li>
                    <a href="#specific-changes-to-ingress" aria-label="Specific Changes to Ingress">Specific Changes to Ingress</a></li></ul>
                    </ul>
                    </ul>
                    </ul>
                </li>
                <li>
                    <a href="#upgrading-to-261" aria-label="Upgrading to 2.6.1">Upgrading to 2.6.1</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Traefik currently seats on a custom version owned by us but the patch was merged into the upstream repository and needs to be back to the main docker image along with the upgrade to &gt; 2.5</p>
<h1 id="steps">Steps<a hidden class="anchor" aria-hidden="true" href="#steps">#</a></h1>
<ol>
<li>Check 2.4 and 2.5 releases for breaking changes</li>
</ol>
<p>Reference: <a href="https://doc.traefik.io/traefik/migration/v2/#v23-to-v24">https://doc.traefik.io/traefik/migration/v2/#v23-to-v24</a>
Reference: <a href="https://doc.traefik.io/traefik/v2.4/migration/v2/#v23-to-v24">https://doc.traefik.io/traefik/migration/v2/#v24-to-v25</a></p>
<ul>
<li>
<p><input checked="" disabled="" type="checkbox"> ServersTransport -&gt; Update RBAC and CRD (To check in Helm chart for 2.4)
This is done by the chart as it updates everything needed.</p>
</li>
<li>
<p><input checked="" disabled="" type="checkbox"> K8S CrossNamespace</p>
</li>
<li>
<p><input checked="" disabled="" type="checkbox"> K8S ExternalName Service</p>
</li>
</ul>
<p>Defined in the values.yaml which will be applied for the upgrade:</p>
<p>![[Pasted image 20220127095012.png]]</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Non-ASCII Domain Names</li>
<li><input checked="" disabled="" type="checkbox"> Update RBAC and CRD definitions.</li>
<li><input checked="" disabled="" type="checkbox"> Headers middleware: ssl redirect options &amp; accessControlAllowOrigin</li>
<li><input checked="" disabled="" type="checkbox"> X.509 CommonName</li>
<li><input checked="" disabled="" type="checkbox"> API version: The extensions/v1beta1 API Version should now be replaced either by networking.k8s.io/v1beta1 or by networking.k8s.io/v1 (as of Kubernetes v1.19+)</li>
</ul>
<p>Paysites (prod and staging)</p>
<pre tabindex="0"><code class="language-fallback" data-lang="fallback">Current: helm.sh/chart=traefik-9.13.0 
Containers:
   traefik2-frontend:
    Image:       javipolo/traefik:2.3.3-router-metrics

We need to put: traefik v2.5.6

❯ helm search repo traefik -l | grep -i 2.5.6
traefik/traefik         	10.9.1       	2.5.6      	A Traefik based Kubernetes ingress controller
</code></pre><ol start="2">
<li>Check helm chart releases for breaking changes</li>
</ol>
<p><a href="https://wiki.cac.washington.edu/display/MCI/Ingress+Resource+Changes+Kubernetes+1.19+through+1.21">https://wiki.cac.washington.edu/display/MCI/Ingress+Resource+Changes+Kubernetes+1.19+through+1.21</a></p>
<p><a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide/">https://kubernetes.io/docs/reference/using-api/deprecation-guide/</a></p>
<p>Changes in Ingress apiVersion make the object to be defined different:</p>
<h5 id="specific-changes-to-ingress">Specific Changes to Ingress<a hidden class="anchor" aria-hidden="true" href="#specific-changes-to-ingress">#</a></h5>
<ul>
<li>
<p><em>spec.backend</em> is renamed to <em>spec.defaultBackend</em></p>
</li>
<li>
<p>The backend <em>serviceName</em> field is renamed to <em>service.name</em></p>
</li>
<li>
<p>Numeric backend <em>servicePort</em> fields are renamed to <em>service.port.number</em></p>
</li>
<li>
<p>String backend <em>servicePort</em> fields are renamed to <em>service.port.name</em></p>
</li>
</ul>
<blockquote>
<p>I changed different YAML manifests where the backend service had a different structure. For each project I changed all the manifests.</p>
</blockquote>
<p>![[GH_changes_SYS-1556.png]]</p>
<ol start="5">
<li>Upgrade tag in staging and deploy to paysites staging</li>
</ol>
<ul>
<li>New parameters needed:</li>
</ul>
<p>![[Pasted image 20220127095012.png]]</p>
<p>&amp;</p>
<p>![[Pasted image 20220127094937.png]]</p>
<p>Latest 2.5.4 version in  is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ helm search repo traefik -l | grep -i 2.5.6
</span></span><span style="display:flex;"><span>traefik/traefik         	10.9.1       	2.5.6      	A Traefik based Kubernetes ingress controller
</span></span></code></pre></div><ul>
<li>Destination chart: <code> &gt; helm show values traefik/traefik --version 10.2.0</code></li>
</ul>
<p>Helm uses the app version as tag so the process to upgrade is:</p>
<pre tabindex="0"><code>helm upgrade -i traefik2 --namespace staging -f values.yaml traefik/traefik
</code></pre><blockquote>
<p>This installs the latest version from Traefik!</p>
</blockquote>
<p>Where values.yaml is the file where we override for our own values.</p>
<pre tabindex="0"><code>helm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.9.1
</code></pre><p>Check the traefik dashboard (http://127.0.0.1:9000) to see the general status of Traefik objects:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl port-forward deployment/traefik2 -n staging 9000:9000
</span></span></code></pre></div><ul>
<li>Added new middleware within the same templates with <namespace>-<middleware-name></li>
</ul>
<p>Example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span>{{- <span style="color:#ae81ff">$name := include &#34;chart.name&#34; . -}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">traefik.containo.us/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Middleware</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;whitelist-{{ $name }}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">ipWhiteList</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">ipStrategy</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">depth</span>: {{ <span style="color:#ae81ff">.Values.whitelist.depth }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sourceRange</span>:
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">range .Values.whitelist.ips }}</span>
</span></span><span style="display:flex;"><span>- {{ <span style="color:#ae81ff">. }}</span>
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">end }}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">traefik.containo.us/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Middleware</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;{{ .Release.Namespace }}-whitelist-{{ $name }}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">ipWhiteList</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">ipStrategy</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">depth</span>: {{ <span style="color:#ae81ff">.Values.rssWhiteList.depth }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sourceRange</span>:
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">range .Values.rssWhiteList.ips }}</span>
</span></span><span style="display:flex;"><span>- {{ <span style="color:#ae81ff">. }}</span>
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">end }}</span>
</span></span></code></pre></div><ol start="8">
<li>Deploy your new ingresses that are pointing to your new apiVersion <strong>networking.k8s.io/v1</strong></li>
</ol>
<p>Once deployed, you probably can check that you haven&rsquo;t missed anything by doing something like.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>❯ k get ingress -o yaml -A | grep apiVersion: | more
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>- apiVersion: networking.k8s.io/v1
</span></span><span style="display:flex;"><span>- apiVersion: networking.k8s.io/v1
</span></span><span style="display:flex;"><span>- apiVersion: networking.k8s.io/v1
</span></span><span style="display:flex;"><span>- apiVersion: networking.k8s.io/v1
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>.
</span></span></code></pre></div><ol start="7">
<li>Upgrade CRDs manually!!!</li>
</ol>
<p>How <a href="https://facelessuser.github.io/pymdown-extensions/extensions/snippets/">snippets work</a>
Great gist &ndash;&gt; <a href="https://gist.github.com/Startouf/bd961cee307a6ad93aba51f082f4b7f6">Useful</a></p>
<p>Traefik CRDs reference: <a href="https://github.com/traefik/traefik/blob/v2.5/docs/content/reference/dynamic-configuration/kubernetes-crd.md">https://github.com/traefik/traefik/blob/v2.5/docs/content/reference/dynamic-configuration/kubernetes-crd.md</a></p>
<p>CRDs to be updated, in particular <a href="https://github.com/traefik/traefik/blob/v2.5/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml">these definitions</a>
and the <a href="https://raw.githubusercontent.com/traefik/traefik/v2.5/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml">RBAC one</a></p>
<ul>
<li>Check current CRDs from Traefik</li>
</ul>
<pre tabindex="0"><code>❯ k get crd | grep traefik
ingressroutes.traefik.containo.us                    2020-10-16T13:49:48Z
ingressroutetcps.traefik.containo.us                 2020-10-16T13:49:48Z
ingressrouteudps.traefik.containo.us                 2020-10-16T13:49:48Z
middlewares.traefik.containo.us                      2020-10-16T13:49:48Z
tlsoptions.traefik.containo.us                       2020-10-16T13:49:48Z
tlsstores.traefik.containo.us                        2020-10-16T13:49:48Z
traefikservices.traefik.containo.us                  2020-10-16T13:49:48Z
</code></pre><ul>
<li>Exported Traefik CRDs</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>k get crd -A | grep traefik | awk <span style="color:#e6db74">&#39;{  print $1 }&#39;</span> | xargs -I % /bin/bash -c <span style="color:#e6db74">&#39;kubectl get crd % -o yaml &gt; %.yaml&#39;</span>
</span></span></code></pre></div><ul>
<li>After being sure that I am in the correct context and those are the CRDs I want to apply</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>❯ ./CRDs.sh
</span></span><span style="display:flex;"><span>Warning: resource customresourcedefinitions/ingressroutes.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ingressroutes.traefik.containo.us configured
</span></span><span style="display:flex;"><span>Warning: resource customresourcedefinitions/ingressroutetcps.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ingressroutetcps.traefik.containo.us configured
</span></span><span style="display:flex;"><span>Warning: resource customresourcedefinitions/ingressrouteudps.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ingressrouteudps.traefik.containo.us configured
</span></span><span style="display:flex;"><span>Warning: resource customresourcedefinitions/middlewares.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/middlewares.traefik.containo.us configured
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/middlewaretcps.traefik.containo.us created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/serverstransports.traefik.containo.us created
</span></span><span style="display:flex;"><span>Warning: resource customresourcedefinitions/tlsoptions.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/tlsoptions.traefik.containo.us configured
</span></span><span style="display:flex;"><span>Warning: resource customresourcedefinitions/tlsstores.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/tlsstores.traefik.containo.us configured
</span></span><span style="display:flex;"><span>Warning: resource customresourcedefinitions/traefikservices.traefik.containo.us is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/traefikservices.traefik.containo.us configured
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created
</span></span></code></pre></div><ul>
<li>After the CRDs are installed, I have a couple more:</li>
</ul>
<pre tabindex="0"><code>❯ k get crd | grep traefik
ingressroutes.traefik.containo.us                    2020-10-16T13:49:48Z
ingressroutetcps.traefik.containo.us                 2020-10-16T13:49:48Z
ingressrouteudps.traefik.containo.us                 2020-10-16T13:49:48Z
middlewares.traefik.containo.us                      2020-10-16T13:49:48Z
middlewaretcps.traefik.containo.us                   2022-02-22T10:05:26Z
serverstransports.traefik.containo.us                2022-02-22T10:05:28Z
tlsoptions.traefik.containo.us                       2020-10-16T13:49:48Z
tlsstores.traefik.containo.us                        2020-10-16T13:49:48Z
traefikservices.traefik.containo.us                  2020-10-16T13:49:48Z
</code></pre><ul>
<li>Now applying the upgrade with Helm to v.2.5.6 (chart version is 10.9.1)</li>
</ul>
<pre tabindex="0"><code>helm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.9.1
</code></pre><ul>
<li>After applying the upgrade, <strong>all went well</strong> although some redirections didn&rsquo;t work in the <strong>staging</strong> environment I applied it. Checked the logs and saw some middlewares were missing:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;entryPointName&#34;</span>:<span style="color:#e6db74">&#34;websecure&#34;</span>,<span style="color:#e6db74">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;error&#34;</span>,<span style="color:#e6db74">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;middleware \&#34;staging-blue-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\&#34; does not exist&#34;</span>,<span style="color:#e6db74">&#34;routerName&#34;</span>:<span style="color:#e6db74">&#34;tushyraw-frontend-blue-redesign-new-join-form-staging-blue-staging-blue-members-tushyraw-com-joinnow@kubernetes&#34;</span>,<span style="color:#e6db74">&#34;time&#34;</span>:<span style="color:#e6db74">&#34;2022-02-22T13:10:37Z&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;entryPointName&#34;</span>:<span style="color:#e6db74">&#34;websecure&#34;</span>,<span style="color:#e6db74">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;error&#34;</span>,<span style="color:#e6db74">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;middleware \&#34;staging-blue-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\&#34; does not exist&#34;</span>,<span style="color:#e6db74">&#34;routerName&#34;</span>:<span style="color:#e6db74">&#34;slayed-frontend-blue-redesign-new-join-form-staging-blue-staging-blue-members-slayed-com-joinnow@kubernetes&#34;</span>,<span style="color:#e6db74">&#34;time&#34;</span>:<span style="color:#e6db74">&#34;2022-02-22T13:10:37Z&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;entryPointName&#34;</span>:<span style="color:#e6db74">&#34;websecure&#34;</span>,<span style="color:#e6db74">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;error&#34;</span>,<span style="color:#e6db74">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;middleware \&#34;staging-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\&#34; does not exist&#34;</span>,<span style="color:#e6db74">&#34;routerName&#34;</span>:<span style="color:#e6db74">&#34;deeper-frontend-redesign-new-join-form-staging-staging-members-deeper-com-joinnow@kubernetes&#34;</span>,<span style="color:#e6db74">&#34;time&#34;</span>:<span style="color:#e6db74">&#34;2022-02-22T13:10:37Z&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;entryPointName&#34;</span>:<span style="color:#e6db74">&#34;websecure&#34;</span>,<span style="color:#e6db74">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;error&#34;</span>,<span style="color:#e6db74">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;middleware \&#34;staging-auth-pass-blacked-frontend-canary-redesign@kubernetescrd\&#34; does not exist&#34;</span>,<span style="color:#e6db74">&#34;routerName&#34;</span>:<span style="color:#e6db74">&#34;vixen-frontend-redesign-new-join-form-staging-staging-members-vixen-com-joinnow@kubernetes&#34;</span>,<span style="color:#e6db74">&#34;time&#34;</span>:<span style="color:#e6db74">&#34;2022-02-22T13:10:37Z&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>After some investigation, I found that in the previous version of Traefik (2.3.3) the middlewares were already missing, so it wasn&rsquo;t a problem with the upgrade.</p>
<blockquote>
<p>In conclusion, the newer version of Traefik (2.5.6) simply gave an incorrect redirection for a Router when a middleware was missing but in the previous version don&rsquo;t.</p>
</blockquote>
<p>In the end, I created the missing middlewares and redirections were working as expected.</p>
<hr>
<h1 id="upgrading-to-261">Upgrading to 2.6.1<a hidden class="anchor" aria-hidden="true" href="#upgrading-to-261">#</a></h1>
<p>❯ ./CRDs_2_6.sh
customresourcedefinition.apiextensions.k8s.io/ingressroutes.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/ingressroutetcps.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/ingressrouteudps.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/middlewares.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/middlewaretcps.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/serverstransports.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/tlsoptions.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/tlsstores.traefik.containo.us configured
customresourcedefinition.apiextensions.k8s.io/traefikservices.traefik.containo.us configured
clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller unchanged
clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller unchanged</p>
<p>❯ helm search repo traefik -l | grep -i 2.6.1
traefik/traefik         	10.14.2      	2.6.1      	A Traefik based Kubernetes ingress controller</p>
<ul>
<li>Change values.yaml tag for &ldquo;2.6.1&rdquo;</li>
</ul>
<p>Then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.14.2 --dry-run
</span></span></code></pre></div><p>Real update:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>❯ helm upgrade -i traefik2 -n staging -f values.yaml traefik/traefik --version 10.14.2
</span></span><span style="display:flex;"><span>Release <span style="color:#e6db74">&#34;traefik2&#34;</span> has been upgraded. Happy Helming!
</span></span><span style="display:flex;"><span>NAME: traefik2
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Wed Feb <span style="color:#ae81ff">23</span> 16:42:11 <span style="color:#ae81ff">2022</span>
</span></span><span style="display:flex;"><span>NAMESPACE: staging
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#ae81ff">29</span>
</span></span><span style="display:flex;"><span>TEST SUITE: None
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://dangaiden.github.io">Dan Belmonte</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
