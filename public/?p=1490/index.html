<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Certificate renewal on Windows ADFS and WAP | IT Gaiden</title>
<meta name="keywords" content="" />
<meta name="description" content="ADFS SERVER (EZINADADFS01-EC) Prerequisites:
 After importing the certificate go to your local certificate store and check the permissions of the current (old) certificate:   The adfssrv is the service that was used before, in my case I have a new account using the ADFS Service:
 I will proceed to grant permissions to that service account:
  Change Service communications certificate  Now, we will change the certificate used by the Service Communications.">
<meta name="author" content="itgaiden">
<link rel="canonical" href="https://dangaiden.github.io/?p=1490/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.35cd0f65a15cafa92372b8313deef5960aae04b90ad722f2bbf509eb0468137e.css" integrity="sha256-Nc0PZaFcr6kjcrgxPe71lgquBLkK1yLyu/UJ6wRoE34=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://dangaiden.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://dangaiden.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dangaiden.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://dangaiden.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://dangaiden.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.85.0" />
<meta property="og:title" content="Certificate renewal on Windows ADFS and WAP" />
<meta property="og:description" content="ADFS SERVER (EZINADADFS01-EC) Prerequisites:
 After importing the certificate go to your local certificate store and check the permissions of the current (old) certificate:   The adfssrv is the service that was used before, in my case I have a new account using the ADFS Service:
 I will proceed to grant permissions to that service account:
  Change Service communications certificate  Now, we will change the certificate used by the Service Communications." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dangaiden.github.io/?p=1490/" /><meta property="article:section" content="posts" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Certificate renewal on Windows ADFS and WAP"/>
<meta name="twitter:description" content="ADFS SERVER (EZINADADFS01-EC) Prerequisites:
 After importing the certificate go to your local certificate store and check the permissions of the current (old) certificate:   The adfssrv is the service that was used before, in my case I have a new account using the ADFS Service:
 I will proceed to grant permissions to that service account:
  Change Service communications certificate  Now, we will change the certificate used by the Service Communications."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://dangaiden.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Certificate renewal on Windows ADFS and WAP",
      "item": "https://dangaiden.github.io/?p=1490/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Certificate renewal on Windows ADFS and WAP",
  "name": "Certificate renewal on Windows ADFS and WAP",
  "description": "ADFS SERVER (EZINADADFS01-EC) Prerequisites:\n After importing the certificate go to your local certificate store and check the permissions of the current (old) certificate:   The adfssrv is the service that was used before, in my case I have a new account using the ADFS Service:\n I will proceed to grant permissions to that service account:\n  Change Service communications certificate  Now, we will change the certificate used by the Service Communications.",
  "keywords": [
    
  ],
  "articleBody": "ADFS SERVER (EZINADADFS01-EC) Prerequisites:\n After importing the certificate go to your local certificate store and check the permissions of the current (old) certificate:   The adfssrv is the service that was used before, in my case I have a new account using the ADFS Service:\n I will proceed to grant permissions to that service account:\n  Change Service communications certificate  Now, we will change the certificate used by the Service Communications.Go to the AD FS console:\nAfter changing the certificate:\n  On the ADFS console I can see now the new certificate:\n  You can do the same in PS and faster:\n  Then as requested before (check the PS window), we proceed to restart the ADFS service:\n        Change http binding  This won’t change the http binding and we need to fix it, you can check it if you perform netsh http show sslcert. The hash starts with b0d (old cert) and the new cert is a44.\n Now execute this command:\nPS C:\\Users\\nttadmin Set-AdfsSslCertificate -Thumbprint a441cfb8dceca0685017a1afad9890ecffa96266\n If it gives you an error like this:\n  FOLLOW THIS:\n******************************\n Check the current FarmBehaviour level with :\nGet-AdfsFarmInformation\n It makes sense for me as this farm was migrated from a W2012. As I don’t have more W2012 servers within the farm we will proceed to raise the level of FarmBehavior (which updates the AD schema)\nThen I executed: Invoke-AdfsFarmBehaviorLevelRaise\nJust Accept if you don’t have any W2012 ADFS servers within the farm.\nSome configuration will be performed in the console (it takes 20-30 seconds in my case):\n After the operation has finished, now my FarmBehavior is at level 3:\n    Execute the command: Set-AdfsSslCertificate -Thumbprint a441cfb8dceca0685017a1afad9890ecffa96266\n We need to restart the ADFS service, but we can check if you run again netsh http show sslcert that is configured correctly:\n And with that, we’re done with the ADFS server, now let’s move to the WAP server.\n***************************\n    WAP SERVER (EZINADWAP01-EC)   Logon to the WAP server and open an elevated PowerShell. Executed the following command: Set-WebApplicationProxySslCertificate -Thumbprint a441cfb8dceca0685017a1afad9890ecffa96266   Curiously, not certificate bindings nor WAP applications:\nThis is because it was automatically deleted after we configured the SSL certificate in the ADFS ?\n Now, we have to re-establish the trust between the WAP and ADFS server\n Install-WebApplicationProxy -CertificateThumbprint ‘a441cfb8dceca0685017a1afad9890ecffa96266’ -FederationServiceName ‘sts.everzinc.com’\nI put the Domain credentials as the WAP server it’s not domain joined (DMZ)\n Now, configure our certificate that will be used for the WAP:\nGet-WebApplicationProxyApplication | Set-WebApplicationProxyApplication -ExternalCertificateThumbprint a441cfb8dceca0685017a1afad9890ecffa96266\n  Now if you check your SSL certificates within the WAP server they look great:\n And now if we ran the same command where there was nothing…we have again our WAP config!\nYou can check that your sindings are correct as well:\n  In the Event Viewer we can confirm that the trust is working flawlessly:\n     ",
  "wordCount" : "453",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "itgaiden"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dangaiden.github.io/?p=1490/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "IT Gaiden",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dangaiden.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://dangaiden.github.io" accesskey="h" title="IT Gaiden (Alt + H)">IT Gaiden</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Certificate renewal on Windows ADFS and WAP<div class="entry-isdraft"><sup>&nbsp;&nbsp;[draft]</sup></div>
    </h1>
    <div class="post-meta">itgaiden
</div>
  </header> 
  <div class="post-content"><h1 id="adfs-server-ezinadadfs01-ec">ADFS SERVER (EZINADADFS01-EC)<a hidden class="anchor" aria-hidden="true" href="#adfs-server-ezinadadfs01-ec">#</a></h1>
<p>Prerequisites:</p>
<ul>
<li>After importing the certificate go to your local certificate store and check the permissions of the current (old) certificate:</li>
</ul>
<p> </p>
<p>The adfssrv is the service that was used before, in my case I have a new account using the ADFS Service:</p>
<p> </p>
<p>I will proceed to grant permissions to that service account:</p>
<p> </p>
<p> </p>
<h2 id="change-service-communications-certificate">Change Service communications certificate<a hidden class="anchor" aria-hidden="true" href="#change-service-communications-certificate">#</a></h2>
<p> </p>
<p>Now, we will change the certificate used by the Service Communications.Go to the AD FS console:</p>
<p>After changing the certificate:</p>
<p> </p>
<p> </p>
<p>On the ADFS console I can see now the new certificate:</p>
<p> </p>
<p> </p>
<p>You can do the same in PS and faster:</p>
<p> </p>
<p> </p>
<p>Then as requested before (check the PS window), we proceed to restart the ADFS service:</p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<h3 id="change-http-binding">Change http binding<a hidden class="anchor" aria-hidden="true" href="#change-http-binding">#</a></h3>
<p> </p>
<p>This won’t change the http binding and we need to fix it, you can check it if you perform netsh http show sslcert. The hash starts with b0d (old cert) and the new cert is a44.</p>
<p> </p>
<p>Now execute this command:</p>
<p>PS C:\Users\nttadmin&gt; Set-AdfsSslCertificate -Thumbprint a441cfb8dceca0685017a1afad9890ecffa96266</p>
<p> </p>
<p>If it gives you an error like this:</p>
<p> </p>
<p> </p>
<p>FOLLOW THIS:</p>
<p>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>****</p>
<p> </p>
<p>Check the current FarmBehaviour level with :</p>
<p>Get-AdfsFarmInformation</p>
<p> </p>
<p>It makes sense for me as this farm was migrated from a W2012. As I don’t have more W2012 servers within the farm we will proceed to raise the level of FarmBehavior (which updates the AD schema)</p>
<p>Then I executed: Invoke-AdfsFarmBehaviorLevelRaise</p>
<p>Just Accept if you don’t have any W2012 ADFS servers within the farm.</p>
<p>Some configuration will be performed in the console (it takes 20-30 seconds in my case):</p>
<p> </p>
<p>After the operation has finished, now my FarmBehavior is at level 3:</p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p>Execute the command: Set-AdfsSslCertificate -Thumbprint a441cfb8dceca0685017a1afad9890ecffa96266</p>
<p> </p>
<p>We need to restart the ADFS service, but we can check if you run again netsh http show sslcert that is configured correctly:</p>
<p> </p>
<p>And with that, we’re done with the ADFS server, now let’s move to the WAP server.</p>
<p>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>*<strong>*</strong>***</p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<h1 id="wap-server-ezinadwap01-ec">WAP  SERVER (EZINADWAP01-EC)<a hidden class="anchor" aria-hidden="true" href="#wap-server-ezinadwap01-ec">#</a></h1>
<p> </p>
<ol>
<li>Logon to the WAP server and open an elevated PowerShell.</li>
<li>Executed the following command: Set-WebApplicationProxySslCertificate -Thumbprint a441cfb8dceca0685017a1afad9890ecffa96266</li>
</ol>
<p> </p>
<p>Curiously, not certificate bindings nor WAP applications:</p>
<p>This is because it was automatically deleted after we configured the SSL certificate in the ADFS ?</p>
<p> </p>
<p>Now, we have to <strong>re-establish the trust</strong> between the WAP and ADFS server</p>
<p> </p>
<p>Install-WebApplicationProxy -CertificateThumbprint ‘a441cfb8dceca0685017a1afad9890ecffa96266’ -FederationServiceName ‘sts.everzinc.com’</p>
<p>I put the Domain credentials as the WAP server it’s not domain joined (DMZ)</p>
<p> </p>
<p>Now, configure our certificate that will be used for the WAP:</p>
<p>Get-WebApplicationProxyApplication | Set-WebApplicationProxyApplication -ExternalCertificateThumbprint a441cfb8dceca0685017a1afad9890ecffa96266</p>
<p> </p>
<p> </p>
<p>Now if you check your SSL certificates within the WAP server they look great:</p>
<p> </p>
<p>And now if we ran the same command where there was nothing…we have again our WAP config!</p>
<p>You can check that your sindings are correct as well:</p>
<p> </p>
<p> </p>
<p>In the Event Viewer we can confirm that the trust is working flawlessly:</p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>


  </div>
  <footer class="post-footer">
  </footer>
</article>
    </main>
    <footer class="footer">
    <span>&copy; 2021 <a href="https://dangaiden.github.io">IT Gaiden</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
